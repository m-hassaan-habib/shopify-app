{% extends "base.html" %}
{% block title %}Customers · ShopFlow{% endblock %}
{% block content %}

<main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-6 mb-10 text-gray-800">
  <!-- Header -->
  <section>
    <h1 class="text-lg font-bold text-gray-900 select-text">Customer Management</h1>
    <p class="text-sm text-gray-600 mt-1 select-text">View and manage your customer relationships</p>
  </section>

  <!-- Summary cards -->
  <section class="mt-6 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 select-text">
    <div class="bg-white border border-gray-200 rounded-lg p-4 flex items-center justify-between">
      <div>
        <p class="text-xs text-gray-500">Total Customers</p>
        <p class="text-xl font-extrabold text-gray-900 mt-1">{{ cards.total }}</p>
      </div>
      <div class="bg-green-100 text-green-600 p-2 rounded-md"><i class="fas fa-user-friends fa-lg"></i></div>
    </div>

    <div class="bg-white border border-gray-200 rounded-lg p-4 flex items-center justify-between">
      <div>
        <p class="text-xs text-gray-500">Valued Customers</p>
        <p class="text-xl font-extrabold text-gray-900 mt-1">{{ cards.valued }}</p>
      </div>
      <div class="bg-orange-100 text-orange-500 p-2 rounded-md"><i class="fas fa-star fa-lg"></i></div>
    </div>

    <div class="bg-white border border-gray-200 rounded-lg p-4 flex items-center justify-between">
      <div>
        <p class="text-xs text-gray-500">New This Month</p>
        <p class="text-xl font-extrabold text-gray-900 mt-1">{{ cards.new_month }}</p>
      </div>
      <div class="bg-green-100 text-green-600 p-2 rounded-md"><i class="fas fa-chart-line fa-lg"></i></div>
    </div>

    <div class="bg-white border border-gray-200 rounded-lg p-4 flex items-center justify-between">
      <div>
        <p class="text-xs text-gray-500">Inactive (30+ days)</p>
        <p class="text-xl font-extrabold text-gray-900 mt-1">{{ cards.inactive30 }}</p>
      </div>
      <div class="bg-gray-100 text-gray-400 p-2 rounded-md"><i class="fas fa-user-clock fa-lg"></i></div>
    </div>
  </section>

  <!-- Toolbar -->
  <section class="mt-6 flex flex-col sm:flex-row sm:items-center sm:space-x-3 space-y-3 sm:space-y-0">
    <form method="get" class="flex-1 flex gap-3">
      <div class="flex-1">
        <label for="search" class="sr-only">Search customers</label>
        <div class="relative text-gray-400 focus-within:text-gray-600">
          <div class="pointer-events-none absolute inset-y-0 left-0 pl-3 flex items-center">
            <i class="fas fa-search"></i>
          </div>
          <input id="search" name="q" value="{{ q }}"
                 type="search" placeholder="Search customers by name, phone, or city..."
                 class="block w-full rounded-md border border-gray-200 py-2 pl-9 pr-3 text-sm placeholder-gray-400 focus:border-gray-300 focus:ring-1 focus:ring-gray-300 focus:outline-none"/>
        </div>
      </div>

      <div>
        <label for="segment" class="sr-only">Segment</label>
        <select id="segment" name="segment"
                class="inline-flex items-center rounded-md border border-gray-200 bg-white py-2 px-3 text-sm shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-1 focus:ring-gray-300">
          {% for opt in ['All','Valued','New','Inactive30','Regular'] %}
            <option value="{{ opt }}" {{ 'selected' if segment==opt }}>{{ opt if opt!='Inactive30' else 'Inactive (30+ days)' }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Preserve page size if you ever expose it -->
      <input type="hidden" name="page" value="1"/>
      <button type="submit"
              class="rounded-md border border-gray-200 bg-white px-3 py-2 text-sm text-gray-700 hover:bg-gray-50">
        Apply
      </button>
    </form>
  </section>

  <!-- Customer grid -->
  <section class="mt-6 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6 select-text">
    {% for c in customers %}
      {% set initials = ( (c.billing_name or '')|trim ).split(' ') %}
      {% set badge = c.badge or 'Regular' %}
      {% set badge_cls = 'bg-green-100 text-green-600' if badge in ['Regular','New'] else ('bg-orange-100 text-orange-500' if badge=='Valued' else 'bg-gray-200 text-gray-500') %}

      <article class="bg-white border border-gray-200 rounded-lg p-5 flex flex-col justify-between">
        <header class="flex items-center space-x-4">
          <div class="flex items-center justify-center w-10 h-10 rounded-full bg-green-500 text-white font-semibold text-sm select-none">
            {{ (initials[0][0] if initials and initials[0] else 'C') ~ (initials[1][0] if initials|length>1 and initials[1] else '') }}
          </div>
          <div class="flex-1 min-w-0">
            <h2 class="text-sm font-bold text-gray-900 truncate">{{ c.billing_name or 'Unknown' }}</h2>
            <p class="text-xs text-gray-600 flex items-center space-x-1">
              <i class="fas fa-phone-alt text-gray-400 text-[10px]"></i>
              <span>{{ c.billing_phone or '—' }}</span>
            </p>
          </div>
          <span class="text-[10px] font-semibold rounded-full px-2 py-0.5 select-none {{ badge_cls }}">{{ badge }}</span>
        </header>

        <div class="mt-3 space-y-1 text-xs text-gray-600">
          <p class="flex items-center space-x-1">
            <i class="fas fa-map-marker-alt text-gray-400 text-[11px]"></i>
            <span>{{ c.billing_city or '—' }}</span>
          </p>
          <p class="flex items-center space-x-1">
            <i class="fas fa-calendar-alt text-gray-400 text-[11px]"></i>
            <span>Joined {{ c.joined_at.strftime('%Y-%m-%d') if c.joined_at else '—' }}</span>
          </p>
        </div>

        <hr class="my-4 border-gray-200"/>

        <div class="grid grid-cols-2 gap-4 text-center text-xs text-gray-600">
          <div>
            <p class="font-bold text-gray-900 text-sm">{{ c.orders_count }}</p>
            <p>Total Orders</p>
          </div>
          <div>
            <p class="font-bold text-gray-900 text-sm">PKR {{ '%.2f'|format(c.total_spent or 0) }}</p>
            <p>Total Spent</p>
          </div>
        </div>

        <p class="mt-3 text-xs text-gray-600 text-center select-text">
          Last order:
          <span class="font-semibold text-gray-900">
            {{ ( ( ( ( ( ( (c.last_order_at) or '') ))) ) and c.last_order_at.strftime('%Y-%m-%d') ) or '—' }}
          </span>
        </p>

        <div class="mt-4 flex space-x-2">
          {% if c.billing_phone %}
          <a href="https://web.whatsapp.com/send?phone={{ c.billing_phone|replace('+','')|replace(' ','') }}"
             target="_blank" rel="noopener"
             class="flex-1 rounded border border-gray-300 py-1.5 text-xs text-gray-700 hover:bg-gray-50 text-center">
            <i class="far fa-comment mr-1"></i> Message
          </a>
          {% else %}
          <button type="button"
                  class="flex-1 rounded border border-gray-300 py-1.5 text-xs text-gray-400 cursor-not-allowed text-center">
            <i class="far fa-comment mr-1"></i> Message
          </button>
          {% endif %}

          <a href="{{ url_for('routes.orders') }}?q={{ (c.billing_phone or c.billing_name or '')|urlencode }}"
             class="flex-1 rounded border border-gray-300 py-1.5 text-xs text-gray-700 hover:bg-gray-50 flex items-center justify-center space-x-1">
            <i class="fas fa-box-open"></i><span>Orders</span>
          </a>
        </div>
      </article>
    {% else %}
      <div class="col-span-full text-center text-sm text-gray-500 py-10">No customers found.</div>
    {% endfor %}
  </section>

  <!-- Pagination -->
  <section class="mt-6 flex flex-col sm:flex-row sm:items-center sm:justify-between text-xs text-gray-500 select-text">
    <p>Showing {{ customers|length }} of {{ total_filtered }} customers</p>
    <nav class="mt-3 sm:mt-0 inline-flex rounded-md shadow-sm" aria-label="Pagination">
      {% set base = url_for('routes.customers') %}
      {% set qs_prev = 'q=' ~ (q|urlencode) ~ '&segment=' ~ (segment|urlencode) ~ '&page=' ~ (page-1) ~ '&per_page=' ~ per_page %}
      {% set qs_next = 'q=' ~ (q|urlencode) ~ '&segment=' ~ (segment|urlencode) ~ '&page=' ~ (page+1) ~ '&per_page=' ~ per_page %}

      <a href="{{ base }}?{{ qs_prev }}"
         class="relative inline-flex items-center rounded-l-md border border-gray-300 bg-white px-3 py-1 text-gray-700 hover:bg-gray-50 {{ 'pointer-events-none opacity-50' if page<=1 }}">
        Previous
      </a>

      <span class="relative z-10 inline-flex items-center border border-gray-300 bg-green-50 px-3 py-1 text-green-600">
        {{ page }}
      </span>

      <a href="{{ base }}?{{ qs_next }}"
         class="relative inline-flex items-center rounded-r-md border border-gray-300 bg-white px-3 py-1 text-gray-700 hover:bg-gray-50 {{ 'pointer-events-none opacity-50' if page>=total_pages }}">
        Next
      </a>
    </nav>
  </section>

  <!-- Actions -->
  <section class="mt-6 flex justify-end space-x-3 select-none">
    <a href="{{ url_for('routes.customers_export') }}?q={{ q|urlencode }}&segment={{ segment|urlencode }}"
       class="inline-flex items-center space-x-2 rounded border border-gray-300 bg-white px-3 py-1 text-xs text-gray-700 hover:bg-gray-50">
      <i class="fas fa-download"></i><span>Export Customers</span>
    </a>
    <a href="{{ url_for('routes.orders') }}?status=Confirmed&q={{ q|urlencode }}"
       class="inline-flex items-center space-x-2 rounded bg-green-500 px-3 py-1 text-xs font-semibold text-white hover:bg-green-600">
      <i class="fas fa-comment-alt"></i><span>Bulk Message</span>
    </a>
  </section>
</main>
{% endblock %}
