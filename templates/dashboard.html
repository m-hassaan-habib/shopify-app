{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<main class="px-4 sm:px-6 lg:px-8 py-6 max-w-7xl mx-auto">

  <!-- Header + actions -->
  <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4">
    <div>
      <h1 class="font-bold text-gray-900 text-lg leading-tight mb-1 select-none">Dashboard</h1>
      <p class="text-xs text-gray-500 select-none">Monitor your orders and manage WhatsApp messaging</p>
    </div>
    <div class="flex space-x-2 mt-3 sm:mt-0">
      <button type="button" onclick="location.reload()" 
        class="flex items-center space-x-1 text-xs text-white bg-emerald-500 hover:bg-emerald-600 rounded-md px-3 py-1 transition active:scale-95">
        <i class="fas fa-sync-alt text-[12px]"></i>
        <span>Refresh</span>
      </button>
    </div>

  </div>

  <!-- 8 stat cards in 2 rows (4 per row on lg+) -->
  {% set stats = [
      ('Total Orders', total_orders, 'fa-cube', 'bg-green-100 text-green-600', 'total'),
      ('Confirmed', confirmed_orders, 'fa-check-circle', 'bg-green-100 text-green-600', 'Confirmed'),
      ('Pending', pending_orders, 'fa-clock', 'bg-orange-100 text-orange-400', 'Pending'),
      ('Cancelled', cancelled_orders, 'fa-times-circle', 'bg-red-100 text-red-500', 'Cancelled'),
      ('Not Responding', not_responding_orders, 'fa-question-circle', 'bg-gray-100 text-gray-400', 'Not Responding'),
      ('Failed Delivery', failed_delivery_orders, 'fa-exclamation-circle', 'bg-orange-100 text-orange-400', 'Failed Delivery'),
      ('Valued Customers', valued_orders, 'fa-user-friends', 'bg-blue-100 text-blue-500', 'Valued'),
      ('To Process', to_process_orders, 'fa-sync-alt', 'bg-green-100 text-green-600', 'To Process')
  ] %}
  <section aria-label="Order status summary" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
    {% for label, value, icon, icon_class, filter in stats %}
    <a href="{{ url_for('routes.filtered_orders', status=filter) }}" aria-hidden="true" title="{{ label }} Icon">
      <div class="bg-white border border-gray-200 rounded-lg p-4 flex justify-between items-center shadow-sm hover:shadow-md transition-shadow duration-300" role="region" aria-labelledby="{{ label | lower | replace(' ', '-') }}">
        <div>
          <p class="text-xs text-gray-500 select-none">{{ label }}</p>
          <p id="{{ label | lower | replace(' ', '-') }}" class="font-bold text-gray-900 text-xl select-text">{{ value }}</p>
        </div>
        <div class="{{ icon_class }} rounded-md p-2">
          <i class="fas {{ icon }} fa-lg"></i>
        </div>
      </div>
    </a>
    {% endfor %}
  </section>

  <!-- Charts + Side panel -->
  <section class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
    <!-- Charts card -->
    <div class="lg:col-span-2 bg-white border border-gray-200 rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow duration-300">
      <!-- Top Products: BAR -->
      <h2 class="font-semibold text-gray-900 text-sm mb-3 flex items-center space-x-1 select-none">
        <i class="fas fa-chart-bar text-green-600"></i>
        <span>Top Products</span>
      </h2>
      <div class="h-64">
        <canvas id="chartTopProducts" class="w-full h-full"></canvas>
      </div>

      <!-- Orders Over Time: LINE -->
      <h2 class="font-semibold text-gray-900 text-sm mb-3 flex items-center space-x-1 select-none mt-8">
        <i class="fas fa-chart-line text-blue-600"></i>
        <span>Orders Over Time</span>
      </h2>
      <div class="h-64">
        <canvas id="chartOrdersOverTime" class="w-full h-full"></canvas>
      </div>
    </div>

    <!-- Right side: CSV + Quick actions -->
    <aside class="space-y-6">
      <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow duration-300">
        <h2 class="font-semibold text-gray-900 text-sm mb-3 flex items-center space-x-1 select-none">
          <i class="fas fa-file-import text-green-600"></i>
          <span>CSV Import</span>
        </h2>
      <form id="csvForm" enctype="multipart/form-data">
        <label for="csvFile"
              class="border border-gray-300 border-dashed rounded-md p-4 mb-3 text-center text-gray-500 text-xs cursor-pointer select-none hover:bg-gray-50 transition block">
          <i class="fas fa-upload fa-lg mb-1"></i>
          <div id="csvLabelText">Drop CSV file here or click to upload</div>
        </label>
        <input class="hidden" type="file" name="file" id="csvFile" required>
        
        <div id="selectedFile" class="text-xs text-gray-600 text-center mb-2 hidden"></div>
        
        <button type="submit"
                class="w-full bg-emerald-500 hover:bg-emerald-600 text-white text-xs font-semibold rounded-md py-2 transition active:scale-95">
          Upload Orders
        </button>
      </form>

      </div>

      <div class="bg-white border border-gray-200 rounded-lg p-4 text-xs shadow-sm hover:shadow-md transition-shadow duration-300">
        <h3 class="font-semibold text-gray-900 mb-2 select-none flex items-center space-x-1">
          <i class="fas fa-bolt text-gray-700"></i>
          <span>Quick Actions</span>
        </h3>

      <form id="send-whatsapp-form" method="post" action="/send_whatsapp_messages" class="space-y-3">
        <div class="mb-3">
          <p class="font-semibold text-gray-700 mb-1 select-none">Message Types to Send</p>
          <div class="space-y-1 text-gray-700">
            <label class="flex items-center space-x-2 cursor-pointer">
              <input type="radio" name="msgType" value="confirmation" class="form-radio text-green-500" checked>
              <span>Confirmation</span>
            </label>
            <label class="flex items-center space-x-2 cursor-pointer">
              <input type="radio" name="msgType" value="cancelled" class="form-radio text-green-500">
              <span>Cancelled Order Follow-up</span>
            </label>
            <label class="flex items-center space-x-2 cursor-pointer">
              <input type="radio" name="msgType" value="return" class="form-radio">
              <span>Return / Failed Delivery</span>
            </label>
            <label class="flex items-center space-x-2 cursor-pointer">
              <input type="radio" name="msgType" value="valued" class="form-radio">
              <span>Valued Customer Promo</span>
            </label>
            <label class="flex items-center space-x-2 cursor-pointer">
              <input type="radio" name="msgType" value="tracking" class="form-radio">
              <span>Courier Tracking</span>
            </label>
          </div>
        </div>

        <div class="flex flex-col sm:flex-row sm:items-center justify-between mt-3 text-gray-500 text-[10px] select-none">
          <div>
            <span class="font-semibold">Auto Mode</span>
            <div>Send messages in the Background</div>
          </div>
          <div class="relative inline-block w-11 h-5">
            <input type="checkbox" name="headless" id="headless"
              class="peer appearance-none w-11 h-5 bg-slate-200 rounded-full checked:bg-emerald-500 cursor-pointer transition-colors duration-300" />
            <label for="headless"
              class="absolute top-0 left-0 w-5 h-5 bg-white rounded-full border border-slate-300 shadow-sm transition-transform duration-300 peer-checked:translate-x-6 peer-checked:border-emerald-600 cursor-pointer"></label>
          </div>
        </div>

        <button type="submit"
          class="w-full bg-emerald-500 hover:bg-emerald-600 text-white text-xs font-semibold rounded-md py-2 flex items-center mb-2 justify-center space-x-2 transition active:scale-95">
          <i class="fas fa-paper-plane"></i>
          <span>Send WhatsApp Messages</span>
        </button>
      </form>


        <form method="post" action="/orders/confirm_all" onsubmit="return confirm('Confirm all orders?');">
          <button type="submit" id="confirm-btn" class="w-full border border-gray-300 rounded-md py-2 text-gray-700 text-xs mt-2 mb-2 hover:bg-gray-50 flex items-center justify-center space-x-2 transition active:scale-95">
            <i class="far fa-check-circle"></i>
            <span>Confirm All Orders</span>
          </button>
        </form>
        <form method="post" action="/orders/delete_all" onsubmit="return confirm('Delete all orders permanently?');">
          <button type="submit" id="delete-btn" class="w-full border border-red-300 rounded-md py-2 text-red-600 text-xs hover:bg-red-50 flex items-center justify-center space-x-2 transition active:scale-95">
            <i class="fas fa-trash-alt"></i>
            <span>Delete All Orders</span>
          </button>
        </form>
      </div>
    </aside>
  </section>

  <!-- Recent Orders -->
  <section class="bg-white border border-gray-200 rounded-lg p-4">
    <h2 class="font-semibold text-gray-900 text-sm mb-4 flex items-center space-x-1 select-none">
      <i class="fas fa-cubes text-green-600"></i>
      <span>Recent Orders</span>
    </h2>
    <div class="overflow-x-auto">
      <table class="w-full text-left text-xs text-gray-600 border-collapse">
        <thead>
          <tr class="border-b border-gray-200">
            <th class="py-2 px-3 font-semibold select-none">Order ID</th>
            <th class="py-2 px-3 font-semibold select-none">Customer</th>
            <th class="py-2 px-3 font-semibold select-none">Amount</th>
            <th class="py-2 px-3 font-semibold select-none">Date</th>
            <th class="py-2 px-3 font-semibold select-none">Status</th>
            <th class="py-2 px-3 font-semibold select-none">Shipping Status</th>
            <th class="py-2 px-3 font-semibold select-none">Courier</th>
            <th class="py-2 px-3 font-semibold select-none">Tracking</th>
            <th class="py-2 px-3 font-semibold select-none">Customer Type</th>
          </tr>
        </thead>
        <tbody>
          {% for order in orders %}
          <tr class="border-b border-gray-100 hover:bg-gray-50 transition-colors cursor-default">
            <td class="py-2 px-3 font-mono text-gray-800 select-text">{{ order.order_number }}</td>
            <td class="py-2 px-3 select-text">{{ order.billing_name }}</td>
            <td class="py-2 px-3 font-semibold select-text">PKR {{ order.total }}</td>
            <td class="py-2 px-3 select-text text-gray-500">
              {{ order.created_at.strftime('%Y-%m-%d') if order.created_at else '' }}
            </td>
            <td class="py-2 px-3">
              <span class="inline-block text-[10px] font-semibold rounded-full px-2 py-0.5 select-none
                {% if order.status == 'Confirmed' %}bg-emerald-600 text-white
                {% elif order.status == 'Pending' %}bg-gray-300 text-gray-700
                {% elif order.status == 'Cancelled' %}bg-red-600 text-white
                {% else %}bg-gray-300 text-gray-700{% endif %}">
                {{ order.status }}
              </span>
            </td>
            <td class="py-2 px-3 select-text">{{ order.shipping_status }}</td>
            <td class="py-2 px-3 select-text">{{ order.courier or order.preferred_courier }}</td>
            <td class="py-2 px-3 select-text">{{ order.tracking_number }}</td>
            <td class="py-2 px-3 select-text">{{ order.customer_type }}</td>
          </tr>
          {% else %}
          <tr><td class="py-2 px-3" colspan="9">No orders found</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div class="flex justify-between items-center mt-4 text-[10px] text-gray-500 select-none flex-wrap gap-2">
      <span>Showing page <strong>{{ current_page }}</strong> of <strong>{{ total_pages }}</strong></span>
      <div class="space-x-2 flex flex-wrap gap-2">
        <a class="border border-gray-300 rounded-md px-3 py-1 hover:bg-gray-50 text-gray-700 transition active:scale-95 {% if current_page == 1 %}opacity-50 pointer-events-none{% endif %}" href="?page={{ current_page - 1 }}">Previous</a>
        <a class="border border-gray-300 rounded-md px-3 py-1 hover:bg-gray-50 text-gray-700 transition active:scale-95 {% if current_page == total_pages %}opacity-50 pointer-events-none{% endif %}" href="?page={{ current_page + 1 }}">Next</a>
      </div>
    </div>
  </section>
  <!-- Fullscreen Loader -->
<div id="loaderOverlay"
     class="fixed inset-0 bg-white bg-opacity-90 z-50 hidden flex flex-col items-center justify-center">
  <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-emerald-500 border-solid"></div>
  <p class="mt-4 text-gray-700 font-medium text-sm">Sending messages, please wait...</p>
</div>

</main>

<!-- Load Chart.js + datalabels plugin -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

<script>
  window.addEventListener('load', function () {
    const TOP_LABELS = {{ top_products_labels | tojson }};
    const TOP_VALUES = {{ top_products_counts | tojson }};
    const OOT_LABELS = {{ orders_over_time_labels | tojson }};
    const OOT_VALUES = {{ orders_over_time_counts | tojson }};

    console.debug('TopProducts:', TOP_LABELS, TOP_VALUES);
    console.debug('OrdersOverTime:', OOT_LABELS, OOT_VALUES);

    function truncateLabel(lbl, n = 22) {
      if (typeof lbl !== 'string') return lbl;
      return lbl.length > n ? lbl.slice(0, n) + '…' : lbl;
    }

(function () {
  const canvas = document.getElementById('chartTopProducts');
  if (!canvas || !window.Chart) return;

  const ctx = canvas.getContext('2d');

  const gradient1 = ctx.createLinearGradient(0, 0, 0, 400);
  gradient1.addColorStop(0, "#34d399");
  gradient1.addColorStop(1, "#059669");

  const gradient2 = ctx.createLinearGradient(0, 0, 0, 400);
  gradient2.addColorStop(0, "#6ee7b7");
  gradient2.addColorStop(1, "#047857");

  const bgColors = TOP_VALUES.map((_, i) => (i % 2 === 0 ? gradient1 : gradient2));

  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: TOP_LABELS,
      datasets: [{
        data: TOP_VALUES,
        backgroundColor: bgColors,
        borderWidth: 0,
          borderRadius: {
            topLeft: 10,
            topRight: 10,
            bottomLeft: 0,
            bottomRight: 0
          },
        borderSkipped: false
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: "#111827",
          titleColor: "#fff",
          bodyColor: "#d1d5db",
          padding: 8,
          cornerRadius: 6,
          displayColors: false
        },
        datalabels: {
          color: "#fff",
          anchor: "end",
          align: "start",
          font: { weight: "bold" },
          formatter: function(value) {
            if (value >= 1000) return (value/1000).toFixed(1) + "K";
            return value;
          }
        }
      },
      scales: {
        x: {
          ticks: {
            color: "#374151",
            font: { size: 11, weight: "500" },
            callback: function(val, index) {
              let lbl = this.getLabelForValue(val);
              return lbl.length > 12 ? lbl.slice(0, 12) + "…" : lbl;
            }
          },
          grid: { display: false }
        },
        y: {
          beginAtZero: true,
          ticks: { color: "#6b7280" },
          grid: { color: "#fff" }
        }
      }
    },
    plugins: [ChartDataLabels]
  });
})();


    // ---- Orders Over Time (LINE with gradient) ----
    (function () {
      const canvas = document.getElementById('chartOrdersOverTime');
      if (!canvas || !window.Chart) return;

      const ctx = canvas.getContext('2d');

      const gradient = ctx.createLinearGradient(0, 0, 0, 300);
      gradient.addColorStop(0, "rgba(37,193,139,0.65)");
      gradient.addColorStop(1, "rgba(37,193,139,0.35)");


      new Chart(ctx, {
        type: 'line',
        data: {
          labels: OOT_LABELS,
          datasets: [{
            label: "Orders Over Time",
            data: OOT_VALUES,
            borderColor: "#059669",
            backgroundColor: gradient,
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointRadius: 5,
            pointBackgroundColor: "#059669",
            pointBorderColor: "#fff",
            pointHoverRadius: 7,
            pointHoverBackgroundColor: "#1d4ed8",
            pointHoverBorderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: "#111827",
              titleColor: "#fff",
              bodyColor: "#d1d5db",
              padding: 10,
              cornerRadius: 6,
              displayColors: false
            }
          },
          scales: {
            x: {
              ticks: { color: "#6b7280", font: { size: 12, weight: "500" } },
              grid: { display: false }
            },
            y: {
              beginAtZero: true,
              ticks: { color: "#6b7280", font: { size: 12 } },
              grid: { color: "#fff" }
            }
          }
        }
      });
    })();

    // CSV submit
    document.getElementById('csvForm')?.addEventListener('submit', function (e) {
      e.preventDefault();
      const formData = new FormData(this);
      fetch('/import', { method: 'POST', body: formData })
        .then(r => r.ok ? location.reload() : alert('Import failed'))
        .catch(() => alert('Import failed'));
    });

    // WhatsApp
    // document.getElementById('send-whatsapp-btn')?.addEventListener('click', () => {
    //   const selected = document.querySelector('#message-type-form input[name="msgType"]:checked')?.value || 'confirmation';
    //   const headless = document.getElementById('headless')?.checked;
    //   const body = new URLSearchParams({
    //     msgType: selected,
    //     headless: headless ? '1' : '0'
    //   });


    //   const btn = document.getElementById('send-whatsapp-btn');
    //   const label = btn.innerText;
    //   btn.disabled = true; btn.innerText = 'Sending...';

    //   fetch('/send_whatsapp_messages', { 
    //     method: 'POST', 
    //     headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, 
    //     body 
    //   })
    //     .then(r => r.json())
    //     .then(json => {
    //       Swal.fire({
    //         icon: json.failed_numbers?.length ? 'warning' : 'success',
    //         title: json.message || 'Done',
    //         text: json.failed_numbers?.length ? `Failed: ${json.failed_numbers.join(", ")}` : '',
    //         confirmButtonColor: '#059669'
    //       });
    //     })

    //     .finally(() => { btn.disabled = false; btn.innerText = label; });


    // Headless toggle
    (function () {
      const t = document.getElementById('headless-toggle');
      if (!t) return;
      t.addEventListener('click', () => {
        const pressed = t.getAttribute('aria-pressed') === 'true';
        t.setAttribute('aria-pressed', String(!pressed));
      });
      t.addEventListener('keydown', (e) => {
        if (e.key === ' ' || e.key === 'Enter') { e.preventDefault(); t.click(); }
      });
    })();
  });

// function handleWhatsappForm(formId, action) {
//   $(formId).submit(function(e) {
//     e.preventDefault();

//     // Show loader
//     $('#loaderOverlay').removeClass('hidden');

//     const $btn = $(this).find('button').prop('disabled', true).text('Sending...');
//     const payload = $(this).serialize();
//     const btn2 = document.getElementById('confirm-btn');
//     const btn3 = document.getElementById('delete-btn');
//     btn2.disabled = true;
//     btn3.disabled = true;

//     $.post(action, payload)
//       .done(function(res) {
//         alert(res.message);
//       })
//       .fail(function() {
//         alert('Failed to send messages.');
//       })
//       .always(function() {
//         // Hide loader
//         $('#loaderOverlay').addClass('hidden');

//         $btn.prop('disabled', false).text('Send WhatsApp Messages');
//         btn2.disabled = false;
//         btn3.disabled = false;
//       });
//   });
// }


// handleWhatsappForm('#send-whatsapp-form', '/send_whatsapp_messages');

  document.getElementById('send-whatsapp-form')?.addEventListener('submit', function (e) {
    e.preventDefault();

    // Show loader
    document.getElementById('loaderOverlay').classList.remove('hidden');

    const form = this;
    const formData = new FormData(form);

    // disable buttons
    const btn = form.querySelector('button[type="submit"]');
    const btn2 = document.getElementById('confirm-btn');
    const btn3 = document.getElementById('delete-btn');
    btn.disabled = true;
    btn2.disabled = true;
    btn3.disabled = true;

    fetch(form.action, {
      method: 'POST',
      body: new URLSearchParams([...formData])
    })
    .then(r => r.json())
    .then(json => {
      Swal.fire({
        icon: json.failed_numbers?.length ? 'warning' : 'success',
        title: json.message || 'Done',
        text: json.failed_numbers?.length ? `Failed: ${json.failed_numbers.join(", ")}` : '',
        confirmButtonColor: '#059669',
        customClass: {
          popup: 'custom-popup',
          title: 'custom-title',
          confirmButton: 'custom-confirm'
        }
      });
    })
    .catch(() => {
      Swal.fire({
        icon: 'error',
        title: 'Error',
        text: 'Failed to send messages.'
      });
    })
    .finally(() => {
      // Hide loader
      document.getElementById('loaderOverlay').classList.add('hidden');

      // reset buttons
      btn.disabled = false;
      btn2.disabled = false;
      btn3.disabled = false;
    });
  });


  document.getElementById('csvFile').addEventListener('change', function () {
    const fileInfo = document.getElementById('selectedFile');
    if (this.files.length > 0) {
      fileInfo.textContent = `📄 ${this.files[0].name}`;
      fileInfo.classList.remove('hidden');
    } else {
      fileInfo.textContent = '';
      fileInfo.classList.add('hidden');
    }
  });
</script>

{% endblock %}
