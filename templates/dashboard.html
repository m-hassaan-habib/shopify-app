{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>

<div class="container-xl py-4">
  <!-- Stats Cards -->
  <section class="row g-3 text-center mb-4 text-white">
    {% set stats = [
        ('Total Orders', total_orders, 'fa-shopping-cart', 'bg-icon-cart'),
        ('Confirmed', confirmed_orders, 'fa-check', 'bg-icon-confirmed'),
        ('Cancelled', cancelled_orders, 'fa-times', 'bg-icon-cancelled'),
        ('Pending', pending_orders, 'fa-clock', 'bg-icon-pending'),
        ('Not Responding', not_responding_orders, 'fa-exclamation-triangle', 'bg-icon-notresponding'),
        ('To Process', to_process_orders, 'fa-cube', 'bg-icon-toprocess')
    ] %}
    {% for label, value, icon, icon_class in stats %}
    <div class="col-6 col-md-2">
      <div class="bg-dark-custom p-3 rounded-3 d-flex flex-column align-items-center">
        <div class="card-icon {{ icon_class }} mb-2"><i class="fas {{ icon }}"></i></div>
        <div class="fs-2 fw-bold">{{ value }}</div>
        <div class="small fw-semibold">{{ label }}</div>
      </div>
    </div>
    {% endfor %}
  </section>

    <!-- Import Orders -->
  <section class="bg-dark-custom p-4 mb-4 rounded-3 text-white">
    <div class="d-flex align-items-center mb-3">
      <h5 class="mb-0 fw-semibold">Import Orders</h5>
    </div>
    <form id="csvForm" enctype="multipart/form-data">
      <div class="mb-2">
        <input class="form-control bg-dark-input border-secondary text-white" type="file" name="file" id="csvFile" required>
      </div>
      <div class="d-flex justify-content-end">
        <button class="btn btn-outline-light btn-sm" type="submit">Import CSV</button>
      </div>
    </form>
    <p class="text-secondary small mb-0">Choose your CSV file</p>
  </section>

  <!-- Charts -->
  <section class="row g-4 mb-4 text-white">
    <div class="col-12 col-md-6">
      <div class="bg-dark-custom p-4 rounded-3">
        <h6 class="fw-semibold mb-3">Top Products</h6>
        <canvas id="topProductsChart" style="max-height: 220px;"></canvas>
      </div>
    </div>
    <div class="col-12 col-md-6">
      <div class="bg-dark-custom p-4 rounded-3">
        <h6 class="fw-semibold mb-3">Orders by City</h6>
        <canvas id="ordersCityChart" style="max-height: 220px;"></canvas>
      </div>
    </div>
  </section>

  <!-- Actions -->
<section class="row g-4 text-white">
<div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
  <form id="send-whatsapp-form" method="post" action="/send_whatsapp" class="d-flex align-items-center gap-2 flex-wrap">
    <div class="form-check form-switch mb-0">
      <input type="checkbox" name="headless" id="headless" class="form-check-input" checked>
      <label for="headless" class="form-check-label text-white">Use Same WhatsApp</label>
    </div>
    <button type="submit" id="send-whatsapp-btn" class="btn btn-outline-light btn-sm">
      <i class="fab fa-whatsapp me-1"></i> Send Messages
    </button>
  </form>

  <div class="d-flex flex-wrap gap-2">
    <form method="post" action="/orders/confirm_all" onsubmit="return confirm('Confirm all orders?');">
      <button type="submit" id="confirm-btn" class="btn btn-outline-light btn-sm">Confirm Orders</button>
    </form>
    <form method="post" action="/orders/delete_all" onsubmit="return confirm('Delete all orders permanently?');">
      <button type="submit" id="delete-btn" class="btn btn-outline-light btn-sm">Delete All Orders</button>
    </form>
  </div>
</div>



    <table class="table mb-0">
      <thead>
        <tr>
          <th scope="col">Order #</th>
          <th scope="col">Customer</th>
          <th scope="col">Amount</th>
          <th scope="col">Date</th>
          <th scope="col">Status</th>
        </tr>
      </thead>
      <tbody>
        {% for order in orders %}
        <tr>
          <td>{{ order.order_number }}</td>
          <td>{{ order.billing_name }}</td>
          <td>PKR {{ order.total }}</td>
          <td>{{ order.created_at.strftime('%Y-%m-%d') }}</td>
          <td>{{ order.status }}</td>
        </tr>
        {% else %}
        <tr>
          <td colspan="8">No orders found</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <div class="pagination-controls">
      <div>
        Showing page <strong>{{ current_page }}</strong> of <strong>{{ total_pages }}</strong>
      </div>
      <div class="d-flex gap-2">
        <a class="btn-pagination {% if current_page == 1 %}disabled{% endif %}" href="?page={{ current_page - 1 }}">Previous</a>
        <a class="btn-pagination {% if current_page == total_pages %}disabled{% endif %}" href="?page={{ current_page + 1 }}">Next</a>
      </div>
    </div>
  </div>
</section>


</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>

new Chart(document.getElementById('topProductsChart'), {
    type: 'line',
    data: {
        labels: {{ top_products_labels | tojson }},
        datasets: [
            {
                label: 'Category A',
                data: {{ top_products_counts | tojson }},
                backgroundColor: 'rgba(59, 130, 246, 0.3)',
                borderColor: '#3b82f6',
                fill: true,
                tension: 0.4,
                stack: 'stack1'
            },
            {
                label: 'Category B',
                data: {{ top_products_counts | tojson }}, // replace with actual second layer if available
                backgroundColor: 'rgba(14, 165, 233, 0.3)',
                borderColor: '#0ea5e9',
                fill: true,
                tension: 0.4,
                stack: 'stack1'
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'top',
                labels: { color: '#ccc' }
            },
            tooltip: {
                mode: 'index',
                intersect: false
            }
        },
        interaction: {
            mode: 'index',
            intersect: false
        },
        scales: {
            x: {
                stacked: true,
                ticks: {
                    color: '#ccc',
                    callback: function(_, idx) {
                        const label = this.chart.data.labels[idx];
                        return label.length > 12 ? label.slice(0, 12) + 'â€¦' : label;
                    }
                }
            },
            y: {
                stacked: true,
                beginAtZero: true,
                ticks: { color: '#ccc' }
            }
        }
    }
});



new Chart(document.getElementById("ordersCityChart"), {
    type: 'pie',
    data: {
        labels: {{ city_labels | safe }},
        datasets: [{
            label: "Orders by City",
            data: {{ city_counts | safe }},
            backgroundColor: ["#ff9f43", "#28c76f", "#00cfe8", "#7367f0", "#ea5455"],
            borderWidth: 1,
            borderColor: '#1e1e1e' // Dark border to match theme
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'right',
                labels: {
                    boxWidth: 15,
                    padding: 10,
                    color: '#ffffff' // White text for dark theme
                }
            }
        }
    }
});


$('#csvForm').submit(function(e) {
    e.preventDefault();
    let formData = new FormData(this);
    $.ajax({
        url: '/import',
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: () => {
            alert('CSV Imported');
            location.reload();
        },
        error: () => alert('Import failed')
    });
});
</script>

<script>
    // Note: The WhatsApp form submission logic seems incomplete or mismatched (e.g., send-whatsapp-btn vs. send-btn).
    // Updating to match the form structure.
    $('form[action="/send_whatsapp"]').submit(function(e) {
        e.preventDefault();
        const $btn = $(this).find('button').prop('disabled', true).text('Sending...');
        const payload = $(this).serialize();
        const btn2 = document.getElementById('confirm-btn');
        const btn3 = document.getElementById('delete-btn');
        btn2.disabled = true;
        btn3.disabled = true;
        $.post('/send_whatsapp', payload)
            .done(function(res) {
                alert(res.message);
            })
            .fail(function() {
                alert('Failed to send messages.');
            })
            .always(function() {
                $btn.prop('disabled', false).text('Send WhatsApp Messages');
                btn2.disabled = false;
                btn3.disabled = false;
            });
    });
</script>
{% endblock %}

<style>
.bg-dark-custom {
    margin-bottom: 1rem; ]
}
.row > [class^="col-"] {
    padding-bottom: 1rem; 
}
</style>