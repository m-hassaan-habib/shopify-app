{% extends "base.html" %}
{% block title %}Orders{% endblock %}
{% block content %}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>

<div class="container-xl py-4">
  <div class="bg-dark-custom p-4 rounded-3 text-white">
    <h2 class="mb-4">Orders - {{ current_filter }}</h2>
    <table class="table table-dark table-hover">
      <thead>
        <tr>
          <th scope="col">Order #</th>
          <th scope="col">Customer</th>
          <th scope="col">Amount</th>
          <th scope="col">Date</th>
          <th scope="col">Status</th>
          <th scope="col">Shipping Status</th>
          <th scope="col">Courier</th>
          <th scope="col">Tracking</th>
          {% if current_filter == 'Confirmed' %}
          <th scope="col">Customer Type</th>
          <th scope="col">Action</th>
          {% else %}
          <th scope="col">Customer Type</th>
          {% endif %}
        </tr>
      </thead>
      <tbody>
        {% for order in orders %}
        <tr>
          <td>{{ order.order_number }}</td>
          <td>{{ order.billing_name }}</td>
          <td>PKR {{ order.total }}</td>
          <td>{{ order.created_at.strftime('%Y-%m-%d') }}</td>
          <td>{{ order.status }}</td>
          <td>{{ order.shipping_status }}</td>
          <td>{{ order.courier or order.preferred_courier }}</td>
          <td>{{ order.tracking_number }}</td>
          {% if current_filter == 'Confirmed' %}
          <td>
            <select class="form-select bg-dark-input border-secondary text-white customer-type" data-order-id="{{ order.id }}">
              <option value="" {% if not order.customer_type %}selected{% endif %}>None</option>
              <option value="Valued" {% if order.customer_type == 'Valued' %}selected{% endif %}>Valued</option>
            </select>
          </td>
          <td>
            <button class="btn btn-outline-light btn-sm update-customer-type" data-order-id="{{ order.id }}">Update</button>
          </td>
          {% else %}
          <td>{{ order.customer_type }}</td>
          {% endif %}
        </tr>
        {% else %}
        <tr>
          <td colspan="{% if current_filter == 'Confirmed' %}10{% else %}9{% endif %}">No orders found</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
  $('.update-customer-type').click(function() {
    const orderId = $(this).data('order-id');
    const customerType = $(this).closest('tr').find('.customer-type').val();
    $.ajax({
      url: `/order/${orderId}/customer_type`,
      type: 'PATCH',
      contentType: 'application/json',
      data: JSON.stringify({ customer_type: customerType }),
      success: function() {
        alert('Customer type updated');
      },
      error: function() {
        alert('Failed to update customer type');
      }
    });
  });
});
</script>
{% endblock %}