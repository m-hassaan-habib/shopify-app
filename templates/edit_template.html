{% extends "base.html" %}
{% block title %}Edit Template{% endblock %}
{% block content %}

<main class="px-6 py-6 max-w-8l mx-auto grid grid-cols-1 lg:grid-cols-12 gap-6">
  <!-- LEFT: Form -->
  <section class="lg:col-span-8 space-y-6">
    <!-- Back + heading -->
    <div class="flex items-center space-x-3">
      <a href="{{ url_for('routes.list_templates') }}"
         class="inline-flex items-center border border-gray-300 rounded-md px-3 py-1.5 text-sm font-medium text-gray-700 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-gray-300">
        <i class="fas fa-arrow-left mr-2 text-xs"></i> Back to Templates
      </a>
      <div>
        <h1 class="text-lg font-semibold text-gray-900">Edit Template</h1>
        <p class="text-xs text-gray-500 -mt-1">Modify your existing template</p>
      </div>
    </div>

    <form id="tplForm" method="post" class="space-y-6">
      <!-- Keep status editable via hidden field so backend doesnâ€™t overwrite -->
      <input type="hidden" name="status" value="{{ template.status or 'Active' }}"/>

      <!-- Template Information -->
      <fieldset class="border border-gray-200 rounded-lg p-5 space-y-4" aria-labelledby="template-info-label">
        <legend id="template-info-label" class="flex items-center space-x-2 font-semibold text-gray-900 text-sm">
          <i class="far fa-comment-alt text-green-500"></i>
          <span>Template Information</span>
        </legend>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label for="template-name" class="block text-xs font-medium text-gray-700 mb-1">
              Template Name <span class="text-red-500">*</span>
            </label>
            <input id="template-name" name="template_name" required
                   value="{{ template.template_name }}"
                   class="block w-full rounded-md border border-gray-300 px-3 py-2 text-sm text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-1 focus:ring-green-500 focus:border-green-500"/>
          </div>
          <div>
            <label for="category" class="block text-xs font-medium text-gray-700 mb-1">
              Category <span class="text-red-500">*</span>
            </label>
            <select id="category" name="category" required
                    class="block w-full rounded-md border border-gray-300 px-3 py-2 text-sm text-gray-900 focus:outline-none focus:ring-1 focus:ring-green-500 focus:border-green-500">
              {% for cat in ['Orders','Marketing','Support','Delivery','Greetings'] %}
                <option value="{{ cat }}" {{ 'selected' if (template.category or 'Orders')==cat }}>{{ cat }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <div>
          <label for="description" class="block text-xs font-medium text-gray-700 mb-1">Description</label>
          <input id="description" name="description"
                 value="{{ template.description or '' }}"
                 class="block w-full rounded-md border border-gray-300 px-3 py-2 text-sm text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-1 focus:ring-green-500 focus:border-green-500"/>
        </div>
      </fieldset>

<!-- Message Content -->
      <fieldset class="border border-gray-200 rounded-lg p-5 space-y-4" aria-labelledby="message-content-label">
        <legend id="message-content-label" class="flex justify-between items-center font-semibold text-gray-900 text-sm">
          <div class="flex items-center space-x-2">
            <i class="far fa-comment-alt text-gray-900"></i>
            <span>Message Content</span>
          </div>
          <span id="lineCount"
                class="text-xs text-gray-500 border border-gray-300 rounded-full px-2 py-0.5 select-none">
            {{ items|length }} lines
          </span>
        </legend>

        <div id="linesWrap" class="space-y-4">
          {# Existing lines (use loop.index) #}
          {% for line in items %}
            <div>
              <label class="block text-xs font-semibold text-gray-400 mb-1 select-none">Line {{ loop.index }}</label>
              <textarea rows="2" name="items"
                        class="line-input block w-full rounded-md border border-gray-300 px-3 py-2 text-xs text-gray-900 placeholder-gray-400 resize-none focus:outline-none focus:ring-1 focus:ring-green-500 focus:border-green-500">{{ line }}</textarea>
            </div>
          {% endfor %}

          {# Pad up to 10 lines (range handles 0 or negative gracefully) #}
          {% set count = items|length %}
          {% for i in range(2 - count) %}
            <div>
              <label class="block text-xs font-semibold text-gray-400 mb-1 select-none">Line {{ count + i + 1 }}</label>
              <textarea rows="2" name="items"
                        class="line-input block w-full rounded-md border border-gray-300 px-3 py-2 text-xs text-gray-900 placeholder-gray-400 resize-none focus:outline-none focus:ring-1 focus:ring-green-500 focus:border-green-500"
                        placeholder="Enter message line {{ count + i + 1 }}..."></textarea>
            </div>
          {% endfor %}
        </div>

        <button type="button" id="btnAddLine"
                class="mt-2 w-full border border-gray-300 rounded-md py-1.5 text-xs font-medium text-gray-600 hover:bg-gray-50 flex items-center justify-center space-x-1">
          <i class="fas fa-plus text-xs"></i>
          <span>Add New Line</span>
        </button>
      </fieldset>
    </form>
  </section>

  <!-- RIGHT: Variables + Live Preview + Status -->
  <aside class="lg:col-span-4 space-y-6">
    <!-- Available Variables -->
    <section class="border border-gray-200 rounded-lg p-4 space-y-3" aria-labelledby="available-vars-label">
      <h2 id="available-vars-label" class="font-semibold text-gray-900 text-sm">Available Variables</h2>
      <p class="text-xs text-blue-600 cursor-pointer select-none">
        Click to copy variables to your clipboard
      </p>
      <div class="space-y-2 mt-2">
        {% for var in ['{name}','{order_id}','{product_name}','{amount}','{address}','{phone}','{city}','{delivery_date}','{tracking_link}','{tracking_number}','{courier_company}'] %}
          <input readonly type="text" value="{{ var }}"
                 class="w-full rounded-md border border-gray-300 px-3 py-1.5 text-xs text-gray-700 cursor-pointer select-all focus:outline-none focus:ring-1 focus:ring-green-500 focus:border-green-500"
                 onclick="this.select();navigator.clipboard.writeText(this.value);"
                 aria-label="Variable {{ var }}"/>
        {% endfor %}
      </div>
    </section>

    <!-- Live Preview -->
    <section class="border border-gray-200 rounded-lg p-4 space-y-3" aria-labelledby="live-preview-label">
      <h2 id="live-preview-label" class="font-semibold text-gray-900 text-sm">Live Preview</h2>
      <pre id="livePreview"
           class="bg-gray-100 rounded-md p-3 text-xs text-gray-700 whitespace-pre-wrap font-mono"
           aria-live="polite"></pre>
      <p class="text-[9px] text-gray-400 select-none">
        Preview with sample data. Variables will be replaced with actual values when sent.
      </p>
    </section>

    <!-- Status (display) -->
    <section class="border border-gray-200 rounded-lg p-4 space-y-3" aria-labelledby="status-label">
      <h2 id="status-label" class="font-semibold text-gray-900 text-sm">Status</h2>
      <div class="flex items-center space-x-2 text-emerald-600 text-xs font-semibold">
        <i class="fas fa-check-circle"></i>
        <span>{{ template.status or 'Active' }} Template</span>
      </div>
      <p class="text-[10px] text-gray-400 select-none">
        This template is {{ (template.status or 'Active')|lower }} and can be used for messaging campaigns.
      </p>
    </section>
  </aside>
</main>

<!-- Floating actions -->
<div class="fixed bottom-6 right-6 flex space-x-3 z-50 max-w-xs w-full" role="region" aria-label="Action buttons">
  <button type="button" id="btnPreviewModal"
          class="inline-flex items-center space-x-2 border border-gray-300 rounded-md px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-gray-300">
    <i class="far fa-eye"></i><span>Preview</span>
  </button>
  <button type="button" id="btnSave"
          class="inline-flex items-center space-x-2 bg-green-500 hover:bg-green-600 text-white rounded-md px-4 py-2 text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-green-500">
    <i class="fas fa-save"></i><span>Save Template</span>
  </button>
</div>

<!-- SweetAlert2 for modal preview -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  // Helpers
  const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
  const $  = (s, r=document) => r.querySelector(s);

  const sample = {
    name: 'Ahmed Hassan',
    order_id: '#ORD-001',
    product_name: 'Wireless Headphones',
    amount: 'PKR 2,950',
    address: '123 Main St, Cairo, Egypt',
    phone: '+20 100 123 4567',
    city: 'Cairo',
    delivery_date: 'January 20, 2024',
    tracking_link: 'https://track.example.com/123456',
    tracking_number: 'TRK123456',
    courier_company: 'FastEx'
  };

  function withSample(text) {
    let t = text || '';
    Object.entries(sample).forEach(([k, v]) => {
      t = t.replaceAll(`{${k}}`, v);
    });
    return t;
  }

  function collectLines() {
    return $$('.line-input').map(t => t.value).filter(v => v && v.trim());
  }

  function renderPreview() {
    const preview = $('#livePreview');
    const joined = collectLines().join('\n');
    preview.textContent = withSample(joined);
    $('#lineCount').textContent = `${collectLines().length} lines`;
  }

  // Initial render
  renderPreview();

  // React to input
  document.getElementById('linesWrap')?.addEventListener('input', renderPreview);

  // Add new line
  document.getElementById('btnAddLine')?.addEventListener('click', () => {
    const wrap = document.getElementById('linesWrap');
    const next = wrap.querySelectorAll('.line-input').length + 1;
    const block = document.createElement('div');
    block.innerHTML = `
      <label class="block text-xs font-semibold text-gray-400 mb-1 select-none">Line ${next}</label>
      <textarea rows="2" name="items"
                class="line-input block w-full rounded-md border border-gray-300 px-3 py-2 text-xs text-gray-900 placeholder-gray-400 resize-none focus:outline-none focus:ring-1 focus:ring-green-500 focus:border-green-500"
                placeholder="Enter message line ${next}..."></textarea>`;
    wrap.appendChild(block);
    renderPreview();
    wrap.querySelector('textarea:last-of-type').focus();
  });

  // Floating preview modal
  document.getElementById('btnPreviewModal')?.addEventListener('click', () => {
    const html = `<pre class="text-left text-xs bg-gray-100 rounded p-3 whitespace-pre-wrap">${withSample(collectLines().join('\\n')).replace(/</g,'&lt;')}</pre>`;
    Swal.fire({
      title: 'Preview',
      html,
      confirmButtonColor: '#059669',
      customClass: { popup: 'text-[1em]', confirmButton: 'text-[0.8em]' }
    });
  });

  // Save
  document.getElementById('btnSave')?.addEventListener('click', () => {
    // enforce required name/category
    if (!$('#template-name')?.value.trim()) {
      $('#template-name').focus(); return;
    }
    if (!$('#category')?.value) {
      $('#category').focus(); return;
    }
    document.getElementById('tplForm').submit();
  });

  // Also re-render preview when name/desc/category change (not required but nice)
  $('#template-name')?.addEventListener('input', renderPreview);
  $('#description')?.addEventListener('input', renderPreview);
</script>

{% endblock %}
